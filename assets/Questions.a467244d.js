import{D as st,m as at,r as b,X as M,s as ot,o as nt,j as $,a as d,c,b as l,A as R,e as it,p as E,F as p,q as F,i as y,x as v,Z as A,d as lt,h,g as w,T as dt}from"./index.130d352d.js";import{a as ct}from"./statistics.c6f92bea.js";import{a as rt}from"./courses.6d178db5.js";import{_ as ut,a as pt,b as yt}from"./FavoriteModal.f0059fe0.js";import{b as I}from"./date.204675eb.js";const vt={class:"container-fluid px-4 pt-4 pb-6"},ht=l("h1",{class:"fs-4 mb-5"},"\u554F\u7B54\u91CF\u67E5\u8A62",-1),mt={key:1,class:"d-flex justify-content-end"},gt={class:"table-responsive"},ft={key:0,class:"table table-striped"},wt=l("th",{style:{"white-space":"nowrap"}},"\u65E5\u671F",-1),_t={style:{"white-space":"nowrap"}},bt={"data-bs-toggle":"tooltip","data-bs-title":"\u7E3D\u6578",title:"\u7E3D\u6578"},Ct={"data-bs-toggle":"tooltip","data-bs-title":"\u65B0\u589E\u554F\u984C",title:"\u65B0\u589E\u554F\u984C"},kt={"data-bs-toggle":"tooltip","data-bs-title":"\u518D\u6B21\u56DE\u8986",title:"\u518D\u6B21\u56DE\u8986"},$t=l("td",{style:{"white-space":"nowrap"}},"\u7E3D\u8A08",-1),Ft={"data-bs-toggle":"tooltip","data-bs-title":"\u7E3D\u6578",title:"\u7E3D\u6578"},St={"data-bs-toggle":"tooltip","data-bs-title":"\u65B0\u589E\u554F\u984C",title:"\u65B0\u589E\u554F\u984C"},qt={"data-bs-toggle":"tooltip","data-bs-title":"\u518D\u6B21\u56DE\u8986",title:"\u518D\u6B21\u56DE\u8986"},Bt={__name:"Questions",setup(Lt){const{apiGetStatsQuestionsSelector:V,apiGetStatsQuestions:G,apiGetStatsQuestionsFavorite:N,apiPostStatsQuestionsFavorite:P,apiDeleteStatsQuestionsFavorite:O}=ct,{apiGetCourseList:U}=rt,g=st.useLoading(),f=at({list:[],type:[],range:[]}),C=b({name:"",type:"unresolved",videoCourseIds:"",range:"",from:I(new Date),to:I(new Date)}),u=b({}),S=b(null),X=async({type:s,videoCourseIds:o,range:t,from:n,to:i})=>(await G({type:s,videoCourseIds:o,range:t,from:n,to:i})).result,Z=async()=>(await U()).courses,z=async()=>{const s=await V(),{result:o}=s;return o},H=async s=>{var t,n,i,a;const o=g.show();try{u.value=await X({...s,videoCourseIds:s.videoCourseIds.join(",")})}catch(e){v("danger","\u67E5\u8A62\u5931\u6557",`${(n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.statusCode}:${(a=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:a.message}`)}finally{o.hide()}},m=b([]),j=()=>{m.value.forEach(o=>o.dispose()),m.value=[],[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(o=>{const t=new dt(o);m.value.push(t)})};M(()=>{m.value.forEach(s=>s.dispose()),m.value=[]}),ot(()=>u.value,async()=>{await A(),j()});const B=b([]),q=async()=>{var o,t,n,i;const s=g.show();try{const{result:a}=await N();B.value=a}catch(a){v("danger","\u53D6\u5F97\u5931\u6557",`${(t=(o=a==null?void 0:a.response)==null?void 0:o.data)==null?void 0:t.statusCode}:${(i=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:i.message}`)}finally{s.hide()}};nt(async()=>{var o,t,n,i;const s=g.show();try{f.list=await Z();const{range:a,type:e}=await z();f.range=a,f.type=e,await q(),await A(),j()}catch(a){v("danger","\u5931\u6557",`${(t=(o=a==null?void 0:a.response)==null?void 0:o.data)==null?void 0:t.statusCode}:${(i=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:i.message}`)}finally{s.hide()}});const L=$(()=>Object.keys(u.value.stats||{})),T=$(()=>L.value.map(s=>{const o=f.list.find(t=>t.id===parseInt(s,10));return{id:s,name:o?o.name:`\u672A\u77E5\u7684\u8AB2\u7A0B\uFF08ID: ${s}\uFF09`}})),J=$(()=>{const s=u.value.date||[],{stats:o}=u.value;return s.map((n,i)=>{const a={date:n,courses:{}};return L.value.forEach(e=>{const r=o[e];if(r){const D=r.total.data[i],Q=r.question.data[i],x=r.reply.data[i];a.courses[e]={total:D,question:Q,reply:x}}else a.courses[e]={total:0,question:0,reply:0}}),a})}),k=$(()=>{const s={};return L.value.forEach(o=>{let t=0,n=0,i=0;const a=u.value.stats[o];a&&(t=a.total.data.reduce((e,r)=>e+r,0),n=a.question.data.reduce((e,r)=>e+r,0),i=a.reply.data.reduce((e,r)=>e+r,0)),s[o]={total:t,question:n,reply:i}}),s});M(()=>{m.value.forEach(s=>s.dispose()),m.value=[]});const K=async s=>{var t,n,i,a;const o=g.show();try{const e=await lt.get(`/v1/stats/questions/${s}/csv`,{responseType:"blob"}),r=new FileReader;r.onload=D=>{const Q=new Blob([D.target.result],{type:"text/csv;charset=utf-8;"}),x=window.URL.createObjectURL(Q),_=document.createElement("a");_.href=x,_.setAttribute("download",`tasks-${s}.csv`),document.body.appendChild(_),_.click(),_.remove()},r.readAsText(e.data,"utf-8")}catch(e){v("danger","\u4E0B\u8F09\u5931\u6557",`${(n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.statusCode}:${(a=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:a.message}`)}finally{o.hide()}},W=s=>{C.value=s,S.value.show()},Y=async s=>{var t,n,i,a;const o=g.show();try{await P({...s,videoCourseIds:s.videoCourseIds.join(",")}),v("success","\u5132\u5B58\u6210\u529F","\u5DF2\u6210\u529F\u5132\u5B58\u5E38\u7528\u8A2D\u5B9A"),await q()}catch(e){v("danger","\u5132\u5B58\u5931\u6557",`${(n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.statusCode}:${(a=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:a.message}`)}finally{o.hide()}},tt=async s=>{var t,n,i,a;const o=g.show();try{await O(s),v("success","\u522A\u9664\u6210\u529F","\u5DF2\u6210\u529F\u522A\u9664\u5E38\u7528\u8A2D\u5B9A"),await q()}catch(e){v("danger","\u522A\u9664\u5931\u6557",`${(n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.statusCode}:${(a=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:a.message}`)}finally{o.hide()}},et=async s=>{C.value={...s,videoCourseIds:s.videoCourseIds.split(",").map(o=>parseInt(o,10))},S.value.hide()};return(s,o)=>(d(),c(p,null,[l("div",vt,[ht,R(ut,{status:"questions",data:f,onSubmit:H,openFavoriteModal:W,queryParams:C.value},null,8,["data","queryParams"]),u.value.id?(d(),it(pt,{key:0,data:u.value},null,8,["data"])):E("",!0),u.value.id?(d(),c("div",mt,[l("button",{onClick:o[0]||(o[0]=t=>K(u.value.id)),type:"button",class:"btn btn-primary"}," \u532F\u51FA ")])):E("",!0),l("div",gt,[u.value.id?(d(),c("table",ft,[l("thead",null,[l("tr",null,[wt,(d(!0),c(p,null,F(y(T),t=>(d(),c("th",{key:t.id,style:{"white-space":"nowrap"}},h(t.name),1))),128))])]),l("tbody",null,[(d(!0),c(p,null,F(y(J),t=>(d(),c("tr",{key:t.date},[l("td",_t,h(t.date),1),(d(!0),c(p,null,F(y(T),n=>(d(),c("td",{key:n.id,style:{"white-space":"nowrap"}},[t.courses[n.id]?(d(),c(p,{key:0},[l("span",bt,h(t.courses[n.id].total),1),w(" / "),l("span",Ct,h(t.courses[n.id].question),1),w(" / "),l("span",kt,h(t.courses[n.id].reply),1)],64)):(d(),c(p,{key:1},[w("-")],64))]))),128))]))),128))]),l("tfoot",null,[l("tr",null,[$t,(d(!0),c(p,null,F(y(T),t=>(d(),c("td",{key:t.id,style:{"white-space":"nowrap"}},[y(k)[t.id]?(d(),c(p,{key:0},[l("span",Ft,h(y(k)[t.id].total),1),w(" / "),l("span",St,h(y(k)[t.id].question),1),w(" / "),l("span",qt,h(y(k)[t.id].reply),1)],64)):(d(),c(p,{key:1},[w("-")],64))]))),128))])])])):E("",!0)])]),R(yt,{ref_key:"FavoriteModalRef",ref:S,status:"questions",data:f,options:C.value,favoriteList:B.value,onSaveFavorite:Y,onApplyFavorite:et,onDeleteFavorite:tt},null,8,["data","options","favoriteList"])],64))}};export{Bt as default};
